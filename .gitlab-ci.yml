stages: [lint, test, security, sonar, publish]

variables:
  GIT_DEPTH: "0"
  TF_IN_AUTOMATION: "true"
  TF_INPUT: "false"

fmt_validate:
  stage: test
  image: hashicorp/terraform:1.6.6
  script:
    - terraform fmt -check -diff -recursive
    - terraform init -backend=false
    - terraform validate

tflint:
  stage: lint
  image: ghcr.io/terraform-linters/tflint:v0.53.0
  script:
    - tflint --init
    - tflint -f compact

checkov:
  stage: security
  image: bridgecrew/checkov:latest
  script:
    - checkov -d . --framework terraform --quiet

trivy_iac:
  stage: security
  image: aquasec/trivy:latest
  script:
    - trivy config --severity HIGH,CRITICAL --exit-code 1 .

sonarqube:
  stage: sonar
  image: sonarsource/sonar-scanner-cli:latest
  script:
    - sonar-scanner
      -Dsonar.host.url="$SONAR_HOST_URL"
      -Dsonar.login="$SONAR_TOKEN"
      -Dsonar.projectKey="$SONAR_PROJECT_KEY"
      -Dsonar.sources="."
      -Dsonar.exclusions="**/.terraform/**,**/*.tfstate,**/*.tfstate.*,**/*.zip,**/*.tgz"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

publish_terraform_module:
  stage: publish
  image: alpine:3.20
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - apk add --no-cache curl tar
    - VERSION="${CI_COMMIT_TAG#v}"
    - MODULE_NAME="${CI_PROJECT_NAME}"
    - test -n "$TERRAFORM_MODULE_SYSTEM"
    - tar -czf module.tgz --exclude=.git --exclude=.terraform .
    - >
      curl --fail
      --header "JOB-TOKEN: $CI_JOB_TOKEN"
      --upload-file module.tgz
      "$CI_API_V4_URL/projects/$CI_PROJECT_ID/packages/terraform/modules/${MODULE_NAME}/${TERRAFORM_MODULE_SYSTEM}/${VERSION}/file"
  artifacts:
    paths: [module.tgz]
    expire_in: 7 days
