stages: [lint, test, security, sonar, build, publish, deploy, cleanup]

variables:
  GIT_DEPTH: "0"
  GIT_LFS_SKIP_SMUDGE: "1"
  TF_IN_AUTOMATION: "true"
  TF_INPUT: "false"
  TF_DIR: "terraform-hw3"
  TERRAFORM_MODULE_SYSTEM: "gitlab"
  DEPLOY_TF_DIR: "deploy/terraform"
  ANSIBLE_DIR: "deploy/ansible"

# ---------------------------
# Terraform module pipeline
# ---------------------------

tf_fmt_validate:
  stage: test
  image:
    name: hashicorp/terraform:1.6.6
    entrypoint: [""]
  script:
    - cd "$TF_DIR"
    - terraform fmt -check -diff -recursive
    - terraform init -backend=false
    - terraform validate
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

tflint:
  stage: lint
  image:
    name: ghcr.io/terraform-linters/tflint:v0.53.0
    entrypoint: [""]
  script:
    - tflint --chdir="$TF_DIR" --init
    - tflint --chdir="$TF_DIR" -f compact
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

checkov:
  stage: security
  image:
    name: bridgecrew/checkov:latest
    entrypoint: [""]
  script:
    - checkov -d "$TF_DIR" --framework terraform --quiet --skip-check CKV_GLB_1,CKV_GLB_3,CKV_GLB_4
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

trivy_iac:
  stage: security
  image:
    name: aquasec/trivy:latest
    entrypoint: [""]
  script:
    - trivy config --severity HIGH,CRITICAL --exit-code 1 "$TF_DIR"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

sonarqube_terraform:
  stage: sonar
  image:
    name: sonarsource/sonar-scanner-cli:latest
    entrypoint: [""]
  script:
    - >
      sonar-scanner
      -Dsonar.host.url="$SONAR_HOST_URL"
      -Dsonar.login="$SONAR_TOKEN"
      -Dsonar.projectKey="$SONAR_PROJECT_KEY"
      -Dsonar.sources="$TF_DIR"
      -Dsonar.exclusions="**/.terraform/**,**/*.tfstate,**/*.tfstate.*,**/*.zip,**/*.tgz"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

tf_build:
  stage: build
  image: alpine:3.20
  script:
    - apk add --no-cache tar
    - tar -czf module.tgz -C "$TF_DIR" .
  artifacts:
    paths: [module.tgz]
    expire_in: 7 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

publish_terraform_module:
  stage: publish
  image: alpine:3.20
  rules:
    - if: '$CI_COMMIT_TAG =~ /^tf-v\d+\.\d+\.\d+.*$/'
  script:
    - apk add --no-cache curl tar
    - VERSION="${CI_COMMIT_TAG#tf-v}"
    - MODULE_NAME="${CI_PROJECT_NAME}"
    - test -n "$TERRAFORM_MODULE_SYSTEM"
    - tar -czf module.tgz -C "$TF_DIR" .
    - >
      curl --fail
      --header "JOB-TOKEN: $CI_JOB_TOKEN"
      --upload-file module.tgz
      "$CI_API_V4_URL/projects/$CI_PROJECT_ID/packages/terraform/modules/${MODULE_NAME}/${TERRAFORM_MODULE_SYSTEM}/${VERSION}/file"
  artifacts:
    paths: [module.tgz]
    expire_in: 7 days

# ---------------------------
# Python app pipeline
# ---------------------------

py_lint:
  stage: lint
  image: python:3.12-slim
  script:
    - cd python-app
    - python -V
    - pip install -U pip ruff
    - ruff check .
    - ruff format --check .
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH
    - if: $CI_COMMIT_TAG

py_tests:
  stage: test
  image: python:3.12-slim
  script:
    - cd python-app
    - python -V
    - pip install -U pip pytest pytest-cov
    - PYTHONPATH=. pytest -q --cov=. --cov-report=xml:coverage.xml
  artifacts:
    paths:
      - python-app/coverage.xml
    expire_in: 7 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH
    - if: $CI_COMMIT_TAG

sonarqube_python:
  stage: sonar
  image:
    name: sonarsource/sonar-scanner-cli:latest
    entrypoint: [""]
  dependencies: [py_tests]
  script:
    - cd python-app
    - >
      sonar-scanner
      -Dsonar.host.url="$SONAR_HOST_URL"
      -Dsonar.login="$SONAR_TOKEN"
      -Dsonar.projectKey="$SONAR_PROJECT_KEY_PYTHON"
      -Dsonar.sources="."
      -Dsonar.exclusions="**/.venv/**,**/__pycache__/**,**/.pytest_cache/**,**/dist/**,**/build/**"
      -Dsonar.python.coverage.reportPaths="coverage.xml"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH
    - if: $CI_COMMIT_TAG

py_build:
  stage: build
  image: python:3.12-slim
  script:
    - cd python-app
    - python -V
    - pip install -U pip build
    - python -m build
  artifacts:
    paths:
      - python-app/dist/
    expire_in: 14 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH
    - if: $CI_COMMIT_TAG

publish_python_artifactory:
  stage: publish
  image: alpine:3.20
  dependencies: [py_build]
  rules:
    - if: '$CI_COMMIT_TAG =~ /^py-v\d+\.\d+\.\d+.*$/'
  script:
    - apk add --no-cache curl
    - test -n "$ARTIFACTORY_URL_PYTHON"
    - test -n "$ARTIFACTORY_REPO"
    - test -n "$ARTIFACTORY_TOKEN"
    - VERSION="${CI_COMMIT_TAG#py-v}"
    - |
      for f in python-app/dist/*; do
        [ -f "$f" ] || continue
        echo "Uploading $f ..."
        curl -f \
          -H "Authorization: Bearer $ARTIFACTORY_TOKEN" \
          -T "$f" \
          "$ARTIFACTORY_URL_PYTHON/artifactory/$ARTIFACTORY_REPO/python-app/$VERSION/$(basename "$f")"
      done
  variables:
    GIT_STRATEGY: none

# ---------------------------
# CD: AWS + Ansible
# ---------------------------

tf_apply_aws:
  stage: deploy
  image:
    name: hashicorp/terraform:1.6.6
    entrypoint: [""]
  rules:
    - if: '$CI_COMMIT_TAG =~ /^py-v\d+\.\d+\.\d+.*$/'
  script:
    - cd "$DEPLOY_TF_DIR"
    - test -n "$AWS_PUBLIC_KEY"
    - terraform init
    - terraform apply -auto-approve
    - APP_IP="$(terraform output -raw public_ip)"
    - cd "$CI_PROJECT_DIR"
    - mkdir -p "$ANSIBLE_DIR"
    - printf "[app]\\n%s ansible_user=ec2-user\\n" "$APP_IP" > "$ANSIBLE_DIR/inventory.ini"
  variables:
    TF_VAR_public_key: "$AWS_PUBLIC_KEY"
    TF_VAR_key_name: "${AWS_KEY_NAME:-ci-deploy-key}"
    TF_VAR_app_port: "${APP_PORT:-8080}"
    TF_VAR_aws_region: "${AWS_DEFAULT_REGION:-us-east-1}"
  artifacts:
    paths:
      - deploy/terraform/terraform.tfstate
      - deploy/terraform/terraform.tfstate.backup
      - deploy/ansible/inventory.ini
    expire_in: 7 days

ansible_deploy:
  stage: deploy
  image: python:3.12-slim
  needs:
    - job: tf_apply_aws
      artifacts: true
    - job: py_build
      artifacts: true
  rules:
    - if: '$CI_COMMIT_TAG =~ /^py-v\d+\.\d+\.\d+.*$/'
  script:
    - apt-get update -y
    - apt-get install -y openssh-client
    - pip install -U pip ansible
    - mkdir -p ~/.ssh
    - test -n "$AWS_SSH_PRIVATE_KEY"
    - echo "$AWS_SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - export ANSIBLE_HOST_KEY_CHECKING=False
    - ARTIFACT_PATH="$(ls python-app/dist/*.whl | head -n 1)"
    - ansible-playbook -i "$ANSIBLE_DIR/inventory.ini" "$ANSIBLE_DIR/playbook.yml" -e "artifact_path=$ARTIFACT_PATH app_port=${APP_PORT:-8080}"

tf_destroy_aws:
  stage: cleanup
  image:
    name: hashicorp/terraform:1.6.6
    entrypoint: [""]
  needs:
    - job: tf_apply_aws
      artifacts: true
  rules:
    - if: '$CI_COMMIT_TAG =~ /^py-v\d+\.\d+\.\d+.*$/'
      when: manual
  script:
    - cd "$DEPLOY_TF_DIR"
    - terraform init
    - terraform destroy -auto-approve
  variables:
    TF_VAR_public_key: "$AWS_PUBLIC_KEY"
    TF_VAR_key_name: "${AWS_KEY_NAME:-ci-deploy-key}"
    TF_VAR_app_port: "${APP_PORT:-8080}"
    TF_VAR_aws_region: "${AWS_DEFAULT_REGION:-us-east-1}"
